<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Portfolio - Tonivest Research</title>
    <link rel="icon" href="assets/logo-nav.png" type="image/png">
    <link rel="stylesheet" href="styles.css"> 
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <div class="app-container">
        <aside class="sidebar">
            <div class="sidebar-logo">
                <span class="logo-text">Tonivest Research</span>
            </div>
            
            <nav class="sidebar-nav">
                <a href="index.html" class="nav-item">
                    <svg class="nav-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/></svg>
                    <span class="nav-label">Company Analysis</span>
                </a>
                
                <a href="valuation.html" class="nav-item">
                    <svg class="nav-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"/></svg>
                    <span class="nav-label">Valuation</span>
                </a>
                
                <a href="port.html" class="nav-item active">
                    <svg class="nav-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 011-1h1m-1 1v1m0 0H4a1 1 0 00-1 1v1m2-2h14m-1 0V5a2 2 0 00-1-1h-1m1 1v1"/></svg>
                    <span class="nav-label">My Portfolio</span>
                </a>
            </nav>
        </aside>

        <main class="main-content">
            <div class="valuation-container">
                <div class="valuation-header">
                    <div class="page-title">
                        <h1>My Portfolio Tracker</h1>
                        <p>Live performance of current investments.</p>
                    </div>
                </div>
                
                <div class="analysis-grid" style="grid-template-columns: 2fr 1fr; align-items: flex-start;">
                    <div class="portfolio-details">
                        <h3 style="margin-bottom: 1rem; font-size: 1.5rem;">Portfolio Overview</h3>
                        <div class="valuation-table-section">
                            <table class="valuation-table">
                                <thead>
                                    <tr>
                                        <th>Ticker</th>
                                        <th>Avg Cost/Share</th>
                                        <th>Market Price</th>
                                        <th>Gain/Loss %</th>
                                    </tr>
                                </thead>
                                <tbody id="portfolio-body">
                                    <tr><td colspan="4" style="text-align: center;">Loading portfolio data...</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                    <div class="portfolio-chart">
                        <h3 style="margin-bottom: 1rem; font-size: 1.5rem;">Sector Diversification</h3>
                        <canvas id="sector-pie-chart"></canvas>
                    </div>
                </div>

                <div class="performance-analysis" style="margin-bottom: 3rem;">
                    <h3 style="font-size: 1.5rem; margin-top: 1rem;">Performance Analysis</h3>
                    <p style="color: #6c757d; margin-bottom: 1.5rem;">As of October 07, 2025</p>
                    <div class="valuation-table-section">
                        <table class="valuation-table">
                            <thead>
                                <tr>
                                    <th style="width: 50%;">Time-weighted rate of return (pre-tax)</th>
                                    <th>MTD</th>
                                    <th>QTD</th>
                                    <th>YTD</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>Individual Portfolio</td>
                                    <td class="price-up">+2.30%</td>
                                    <td class="price-up">+2.30%</td>
                                    <td class="price-up">+30.52%</td>
                                </tr>
                                <tr>
                                    <td>S&P 500Â® Index</td>
                                    <td class="price-up">+0.8%</td>
                                    <td class="price-up">+0.8%</td>
                                    <td class="price-up">+15.75%</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // !!! IMPORTANT: Paste your free API key from Financial Modeling Prep here
            // The API key you provided is used here as an example.
            const apiKey = 'J9ls4xtu2AY9PKEECzOdkhIx5U4y74eR';

            // --- Main function to load all data ---
            async function loadPortfolio() {
                try {
                    // Only fetch current trades
                    // Ensure you have a 'data/trades.json' file accessible
                    const response = await fetch('data/trades.json');
                    if (!response.ok) {
                        throw new Error('Failed to load trades.json. Check the file path.');
                    }
                    const tradesData = await response.json();
                    
                    // Process and render the portfolio
                    processAndRenderPortfolio(tradesData);

                } catch (error) {
                    console.error("Error loading portfolio:", error);
                    document.getElementById('portfolio-body').innerHTML = `<tr><td colspan="4" style="text-align: center; color: red;">Could not load portfolio data. (Details: ${error.message})</td></tr>`;
                }
            }

            // --- Process and Render Current Portfolio ---
            async function processAndRenderPortfolio(currentTrades) {
                if (!apiKey || apiKey === 'YOUR_FMP_API_KEY') {
                    const errorMessage = `<tr><td colspan="4" style="text-align: center; color: orange;">Please add your FMP API key to the script.</td></tr>`;
                    document.getElementById('portfolio-body').innerHTML = errorMessage;
                    return;
                }
                
                // 1. Prepare data for the TABLE (excluding CASH)
                const tradesForTable = currentTrades.filter(trade => trade.ticker !== 'CASH');

                // Aggregate holdings for the TABLE
                const aggregatedForTable = tradesForTable.reduce((acc, trade) => {
                    if (!acc[trade.ticker]) {
                        acc[trade.ticker] = { shares: 0, totalCost: 0, company: trade.company };
                    }
                    acc[trade.ticker].shares += parseFloat(trade.shares);
                    acc[trade.ticker].totalCost += parseFloat(trade.shares) * parseFloat(trade.cost_share);
                    return acc;
                }, {});

                const portfolioForTable = Object.entries(aggregatedForTable).map(([ticker, data]) => ({
                    ticker,
                    company: data.company,
                    shares: data.shares,
                    costPerShare: data.shares > 0 ? data.totalCost / data.shares : 0,
                    totalCost: data.totalCost
                }));
                
                // Get all unique tickers for the API call (excluding CASH)
                const tickersForApi = portfolioForTable.map(p => p.ticker).join(',');
                
                let priceMap = {};
                if (tickersForApi.length > 0) {
                    // FIX: Updated the API URL format to use the `?symbol=` query parameter
                    const apiUrl = `https://financialmodelingprep.com/stable/quote?symbol=${tickersForApi}&apikey=${apiKey}`;
                    
                    const marketResponse = await fetch(apiUrl);
                    if (!marketResponse.ok) throw new Error('Failed to fetch market prices from FMP.');
                    
                    const marketData = await marketResponse.json();
                    
                    // This logic correctly maps the array response [ {symbol: "AAPL", price: X}, ... ] 
                    // into the priceMap object { "AAPL": X, ... }
                    priceMap = marketData.reduce((map, stock) => { 
                        map[stock.symbol] = stock.price; 
                        return map; 
                    }, {});
                }

                const portfolioBody = document.getElementById('portfolio-body');
                let html = '';
                let portfolioWithMarketDataForChart = []; // Will be used later for chart

                // Render the table
                for (const stock of portfolioForTable) {
                    const marketPrice = priceMap[stock.ticker] || 0;
                    const totalValue = stock.shares * marketPrice;
                    const gainLoss = totalValue - stock.totalCost;
                    const gainLossPercent = (stock.totalCost > 0) ? (gainLoss / stock.totalCost) * 100 : 0;
                    const gainClass = gainLoss >= 0 ? 'price-up' : 'price-down';

                    html += `
                        <tr>
                            <td>
                                <div class="company-name-main">${stock.ticker}</div>
                                <div class="company-name-sub">${stock.company}</div>
                            </td>
                            <td>$${stock.costPerShare.toFixed(2)}</td>
                            <td>$${marketPrice.toFixed(2)}</td>
                            <td class="${gainClass}">${gainLossPercent.toFixed(1)}%</td>
                        </tr>
                    `;
                    // Add stock data (equity only) for chart preparation
                    portfolioWithMarketDataForChart.push({...stock, totalValue});
                }
                portfolioBody.innerHTML = html;

                // 2. Prepare data for the CHART (including CASH)
                // Aggregate ALL current holdings for chart
                const aggregatedForAll = currentTrades.reduce((acc, trade) => {
                    if (!acc[trade.ticker]) {
                        acc[trade.ticker] = { shares: 0, totalCost: 0, company: trade.company };
                    }
                    acc[trade.ticker].shares += parseFloat(trade.shares);
                    acc[trade.ticker].totalCost += parseFloat(trade.shares) * parseFloat(trade.cost_share);
                    return acc;
                }, {});

                const portfolioForAll = Object.entries(aggregatedForAll).map(([ticker, data]) => ({
                    ticker,
                    company: data.company,
                    shares: data.shares,
                    totalCost: data.totalCost
                }));
                
                // Calculate total value for ALL assets (including CASH) for the chart
                let finalChartData = [];
                for (const stock of portfolioForAll) {
                    let totalValue;
                    if (stock.ticker === 'CASH') {
                        // For cash, the total value is the total cost
                        totalValue = stock.totalCost;  
                    } else {
                        // For equity and others, use the market price if available, otherwise cost
                        const marketPrice = priceMap[stock.ticker] || (stock.shares > 0 ? stock.totalCost / stock.shares : 0);
                        totalValue = stock.shares * marketPrice;
                    }
                    finalChartData.push({...stock, totalValue});
                }
                
                // Render the chart using ALL data
                renderSectorChart(finalChartData);
            }

            // --- Render Sector Chart ---
            function renderSectorChart(portfolioData) {
                // IMPORTANT: Ensure this map covers all tickers in your trades.json
                const sectorMap = {"GOOG": "Communication Services", "TSM": "Technology", "CVS": "Healthcare", "WMT": "Consumer Staples","BTCUSD": "Cryptocurrency", "CASH": "Cash","EXLS": "Technology" };
                const sectorAllocation = portfolioData.reduce((acc, stock) => {
                    const sector = sectorMap[stock.ticker] || "Other";
                    if (!acc[sector]) { acc[sector] = 0; }
                    acc[sector] += stock.totalValue;
                    return acc;
                }, {});
                
                const ctx = document.getElementById('sector-pie-chart').getContext('2d');
                
                // Destroy any existing chart instance to prevent errors
                if (Chart.getChart(ctx)) {
                    Chart.getChart(ctx).destroy();
                }

                new Chart(ctx, {
                    type: 'pie',
                    data: {
                        labels: Object.keys(sectorAllocation),
                        datasets: [{
                            label: 'Portfolio Value',
                            data: Object.values(sectorAllocation),
                            backgroundColor: ['#0f1d2f', '#1E3A5F', '#A9B4C2', '#8F9AAB', '#4a6fa5', '#1e5288', '#163e63', '#666666', '#AAAAAA'],
                            borderColor: '#ffffff',
                            borderWidth: 2
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: {
                                position: 'top',
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        let label = context.label || '';
                                        if (label) {
                                            label += ': ';
                                        }
                                        if (context.parsed !== null) {
                                            const total = context.chart.data.datasets[0].data.reduce((a, b) => a + b, 0);
                                            const percentage = (total > 0) ? (context.parsed / total * 100).toFixed(1) : 0;
                                            label += `${percentage}% ($${context.parsed.toFixed(2)})`; // Added dollar value to tooltip
                                        }
                                        return label;
                                    }
                                }
                            }
                        }
                    }
                });
            }

            // --- Start the process ---
            loadPortfolio();
        });
    </script>
</body>
</html>
