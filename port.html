<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Portfolio - Tonivest Research</title>
    <link rel="icon" href="assets/logo-nav.png" type="image/png">
    <link rel="stylesheet" href="styles.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <div class="app-container">
        <aside class="sidebar">
            <div class="sidebar-logo">
                <span class="logo-text">Tonivest Research</span>
                <button id="sidebar-toggle" class="sidebar-toggle" aria-label="Toggle Sidebar">
                    <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"/></svg>
                </button>
            </div>

            <nav class="sidebar-nav">
                <a href="index.html" class="nav-item">
                    <svg class="nav-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/></svg>
                    <span class="nav-label">Company Analysis</span>
                </a>

                <a href="port.html" class="nav-item active">
                    <svg class="nav-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 011-1h1m-1 1v1m0 0H4a1 1 0 00-1 1v1m2-2h14m-1 0V5a2 2 0 00-1-1h-1m1 1v1"/></svg>
                    <span class="nav-label">My Portfolio</span>
                </a>

                <a href="tools.html" class="nav-item">
                    <svg class="nav-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z"/></svg>
                    <span class="nav-label">Tools &amp; Projects</span>
                </a>

                <a href="about.html" class="nav-item">
                    <svg class="nav-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/></svg>
                    <span class="nav-label">About Me</span>
                </a>
            </nav>
        </aside>

        <main class="main-content">
            <div class="valuation-container">
                <div class="valuation-header">
                    <div class="page-title">
                        <h1>My Portfolio</h1>
                        <p>Live performance of current investments, powered by Finnhub.</p>
                    </div>
                </div>

                <!-- Top row: Holdings table + Sector chart -->
                <div class="portfolio-grid" style="margin-bottom: 1.5rem;">

                    <!-- Holdings -->
                    <div class="port-section-card portfolio-details">
                        <div class="port-section-header">
                            <h3 class="port-section-title">Portfolio Holdings</h3>
                            <span class="port-as-of" id="price-timestamp">Fetching live prices…</span>
                        </div>
                        <div class="valuation-table-section">
                            <table class="valuation-table">
                                <thead>
                                    <tr>
                                        <th>Ticker</th>
                                        <th>Avg Cost / Share</th>
                                        <th>Market Price</th>
                                        <th>Gain / Loss</th>
                                    </tr>
                                </thead>
                                <tbody id="portfolio-body">
                                    <tr><td colspan="4" style="text-align:center; color:#6c757d;">Loading portfolio data…</td></tr>
                                </tbody>
                            </table>
                        </div>
                        <p class="disclaimer-note">
                            Market prices are fetched in real time via Finnhub. Prices may be delayed up to 15 minutes. This page is for informational purposes only and does not constitute investment advice.
                        </p>
                    </div>

                    <!-- Sector Pie -->
                    <div class="port-section-card portfolio-chart">
                        <div class="port-section-header">
                            <h3 class="port-section-title">Sector Allocation</h3>
                        </div>
                        <canvas id="sector-pie-chart"></canvas>
                    </div>

                </div>

                <!-- Performance Analysis -->
                <div class="port-section-card" style="margin-bottom: 3rem;">
                    <div class="port-section-header">
                        <h3 class="port-section-title">Performance Analysis</h3>
                        <span class="port-as-of">As of October 07, 2025</span>
                    </div>
                    <div class="valuation-table-section">
                        <table class="valuation-table">
                            <thead>
                                <tr>
                                    <th style="width:50%;">Time-weighted rate of return (pre-tax)</th>
                                    <th>MTD</th>
                                    <th>QTD</th>
                                    <th>YTD</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>Individual Portfolio</td>
                                    <td class="price-up">+2.30%</td>
                                    <td class="price-up">+2.30%</td>
                                    <td class="price-up">+30.52%</td>
                                </tr>
                                <tr>
                                    <td>S&amp;P 500® Index</td>
                                    <td class="price-up">+0.8%</td>
                                    <td class="price-up">+0.8%</td>
                                    <td class="price-up">+15.75%</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <p class="disclaimer-note">
                        Performance figures are time-weighted and pre-tax. Benchmark is the S&amp;P 500 Total Return Index. Past performance is not indicative of future results.
                    </p>
                </div>

            </div>
        </main>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- Sidebar Toggle ---
            const sidebar = document.querySelector('.sidebar');
            const toggleBtn = document.getElementById('sidebar-toggle');
            if (localStorage.getItem('sidebar-collapsed') === 'true') {
                sidebar.classList.add('collapsed');
            }
            toggleBtn.addEventListener('click', () => {
                sidebar.classList.toggle('collapsed');
                localStorage.setItem('sidebar-collapsed', sidebar.classList.contains('collapsed'));
            });

            // --- Finnhub API Key ---
            const apiKey = 'ctj1dchr01qgfbsvp4mgctj1dchr01qgfbsvp4n0';

            async function loadPortfolio() {
                try {
                    const response = await fetch('data/trades.json');
                    if (!response.ok) throw new Error('Failed to load trades.json. Check the file path.');
                    const tradesData = await response.json();
                    processAndRenderPortfolio(tradesData);
                } catch (error) {
                    console.error('Error loading portfolio:', error);
                    document.getElementById('portfolio-body').innerHTML =
                        `<tr><td colspan="4" style="text-align:center;color:red;">Could not load portfolio data. (${error.message})</td></tr>`;
                }
            }

            async function processAndRenderPortfolio(currentTrades) {
                // Filter out CASH and BTCUSD for the holdings table
                const tradesForTable = currentTrades.filter(t => t.ticker !== 'CASH' && t.ticker !== 'BTCUSD');

                const aggregatedForTable = tradesForTable.reduce((acc, trade) => {
                    if (!acc[trade.ticker]) acc[trade.ticker] = { shares: 0, totalCost: 0, company: trade.company };
                    acc[trade.ticker].shares    += parseFloat(trade.shares);
                    acc[trade.ticker].totalCost += parseFloat(trade.shares) * parseFloat(trade.cost_share);
                    return acc;
                }, {});

                const portfolioForTable = Object.entries(aggregatedForTable).map(([ticker, data]) => ({
                    ticker,
                    company: data.company,
                    shares: data.shares,
                    costPerShare: data.shares > 0 ? data.totalCost / data.shares : 0,
                    totalCost: data.totalCost
                }));

                // Fetch live prices
                const uniqueTickers = portfolioForTable.map(p => p.ticker);
                let priceMap = {};
                if (uniqueTickers.length > 0) {
                    try {
                        const results = await Promise.all(
                            uniqueTickers.map(symbol =>
                                fetch(`https://finnhub.io/api/v1/quote?symbol=${symbol}&token=${apiKey}`)
                                    .then(res => { if (!res.ok) throw new Error(`Failed: ${symbol}`); return res.json(); })
                                    .then(data => ({ symbol, price: data.c }))
                            )
                        );
                        priceMap = results.reduce((map, item) => { map[item.symbol] = item.price; return map; }, {});
                    } catch (err) {
                        console.error('Error fetching prices:', err);
                    }
                }

                // Update timestamp
                const ts = document.getElementById('price-timestamp');
                if (ts) ts.textContent = 'Live · ' + new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

                // Render holdings table
                let html = '';
                let portfolioWithMarketData = [];
                for (const stock of portfolioForTable) {
                    const marketPrice   = priceMap[stock.ticker] || 0;
                    const totalValue    = stock.shares * marketPrice;
                    const gainLoss      = totalValue - stock.totalCost;
                    const gainLossPct   = stock.totalCost > 0 ? (gainLoss / stock.totalCost) * 100 : 0;
                    const gainClass     = gainLoss >= 0 ? 'price-up' : 'price-down';
                    const sign          = gainLossPct >= 0 ? '+' : '';

                    html += `
                        <tr>
                            <td>
                                <div class="company-name-main">${stock.ticker}</div>
                                <div class="company-name-sub">${stock.company}</div>
                            </td>
                            <td>$${stock.costPerShare.toFixed(2)}</td>
                            <td>$${marketPrice.toFixed(2)}</td>
                            <td class="${gainClass}">${sign}${gainLossPct.toFixed(1)}%</td>
                        </tr>`;
                    portfolioWithMarketData.push({ ...stock, totalValue });
                }
                document.getElementById('portfolio-body').innerHTML = html;

                // Build chart data (include CASH, exclude BTCUSD)
                const tradesForChart = currentTrades.filter(t => t.ticker !== 'BTCUSD');
                const aggregatedForAll = tradesForChart.reduce((acc, trade) => {
                    if (!acc[trade.ticker]) acc[trade.ticker] = { shares: 0, totalCost: 0, company: trade.company };
                    acc[trade.ticker].shares    += parseFloat(trade.shares);
                    acc[trade.ticker].totalCost += parseFloat(trade.shares) * parseFloat(trade.cost_share);
                    return acc;
                }, {});

                const finalChartData = Object.entries(aggregatedForAll).map(([ticker, data]) => {
                    const totalValue = ticker === 'CASH'
                        ? data.totalCost
                        : data.shares * (priceMap[ticker] || (data.shares > 0 ? data.totalCost / data.shares : 0));
                    return { ticker, company: data.company, shares: data.shares, totalCost: data.totalCost, totalValue };
                });

                renderSectorChart(finalChartData);
            }

            function renderSectorChart(portfolioData) {
                const sectorMap = {
                    "GOOG": "Communication Services",
                    "TSM":  "Technology",
                    "CVS":  "Healthcare",
                    "NVO":  "Healthcare",
                    "CASH": "Cash"
                };

                const sectorAllocation = portfolioData.reduce((acc, stock) => {
                    const sector = sectorMap[stock.ticker] || 'Other';
                    acc[sector] = (acc[sector] || 0) + stock.totalValue;
                    return acc;
                }, {});

                const ctx = document.getElementById('sector-pie-chart').getContext('2d');
                if (Chart.getChart(ctx)) Chart.getChart(ctx).destroy();

                new Chart(ctx, {
                    type: 'pie',
                    data: {
                        labels: Object.keys(sectorAllocation),
                        datasets: [{
                            label: 'Portfolio Value',
                            data: Object.values(sectorAllocation),
                            backgroundColor: ['#0f1d2f', '#1E3A5F', '#4a6fa5', '#A9B4C2', '#8F9AAB', '#1e5288', '#163e63'],
                            borderColor: '#ffffff',
                            borderWidth: 2
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: { position: 'bottom' },
                            tooltip: {
                                callbacks: {
                                    label(context) {
                                        const total = context.chart.data.datasets[0].data.reduce((a, b) => a + b, 0);
                                        const pct   = total > 0 ? (context.parsed / total * 100).toFixed(1) : 0;
                                        return `${context.label}: ${pct}%`;
                                    }
                                }
                            }
                        }
                    }
                });
            }

            loadPortfolio();
        });
    </script>
</body>
</html>
